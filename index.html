<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ 1447â€“1448 | Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø«</title>
  <!-- Ù…ÙƒØªØ¨Ø© ØªØµØ¯ÙŠØ± PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Tahoma", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      margin: 0 0 10px;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 15px;
      color: #6b7280;
      font-size: 14px;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-visitor {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-admin {
      background: #dcfce7;
      color: #166534;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
    }

    button.secondary {
      background: #6b7280;
    }

    button.small {
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 999px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 15px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .filter-row input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .legend {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-inline-start: 8px;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #9ca3af;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø´Ù‡Ø±: Ø´Ù‡Ø±ÙŠÙ† ÙÙŠ Ø§Ù„ØµÙ */
    #calendarContainer {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .month-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      min-height: 280px;
    }

    .month-header {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      background: #f3f4ff;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .month-name {
      font-weight: bold;
      font-size: 14px;
    }

    .month-range {
      font-size: 11px;
      color: #6b7280;
    }

    .month-body {
      padding: 6px;
      flex: 1;
    }

    table.month-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }

    .month-table th {
      padding: 4px 2px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: bold;
      color: #6b7280;
      text-align: center;
    }

    .month-table td {
      border: 1px solid #f3f4f6;
      vertical-align: top;
      height: 60px;
      padding: 2px;
      position: relative;
      cursor: pointer;
      background: #ffffff;
    }

    .month-table td.out-of-range {
      background: #f9fafb;
      color: #9ca3af;
      cursor: default;
    }

    .month-table td.prev-next {
      background: #f9fafb;
      color: #9ca3af;
    }

    .day-number {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .event-list {
      max-height: 44px;
      overflow: hidden auto;
    }

    /* Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø¢Ù† ÙŠÙ„ØªÙ Ù†ØµÙ‡ (multi-line) */
    .event-pill {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      border-radius: 999px;
      padding: 2px 6px;
      margin-bottom: 2px;
      font-size: 11px;
      color: #ffffff;
      cursor: pointer;
      width: 100%;
      gap: 4px;
    }

    .event-text {
      flex: 1;
      white-space: normal;      /* Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ */
      overflow: hidden;
      text-overflow: clip;      /* Ø¨Ø¯ÙˆÙ† ... */
      line-height: 1.2;
    }

    .event-delete {
      margin-right: 2px;
      margin-left: 2px;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }

    .event-delete.disabled {
      cursor: default;
      opacity: 0.5;
    }

    /* Ø£Ø´ÙƒØ§Ù„ Ø®Ø§ØµØ© Ù„Ø±Ø¨Ø· Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø« Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ© */
    .event-pill.range-single {
      border-radius: 999px;
    }

    .event-pill.range-start {
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }

    .event-pill.range-mid {
      border-radius: 4px;
    }

    .event-pill.range-end {
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    /* Ø­ÙˆØ§Ø± Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« */
    .dialog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .dialog-hidden {
      display: none;
    }

    .dialog-box {
      background: #ffffff;
      padding: 16px 18px;
      border-radius: 10px;
      width: 320px;
      max-width: 95vw;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      font-size: 13px;
    }

    .dialog-box h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .dialog-row {
      margin-bottom: 8px;
    }

    .dialog-row label {
      display: block;
      margin-bottom: 3px;
      font-size: 12px;
    }

    .dialog-row input,
    .dialog-row select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    /* Ø­ÙˆØ§Ø± Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« */
    .event-view-text {
      padding: 8px;
      border-radius: 6px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
    }

    .event-view-date {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 900px) {
      #calendarContainer {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .page {
        margin: 0;
        border-radius: 0;
        box-shadow: none;
      }
      #calendarContainer {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }

    /* ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body {
        background: #ffffff;
      }
      .page {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
      }
      .status-bar,
      .filter-row,
      .legend,
      .hint,
      .dialog-backdrop {
        display: none !important;
      }
      button {
        display: none !important;
      }
      #calendarContainer {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .month-card {
        border: 1px solid #d1d5db;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ (Ù‡Ø¬Ø±ÙŠ) Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h1>
    <div class="subtitle">
      Ø§Ù„ÙØªØ±Ø© Ù…Ù† <strong>29 Ø±Ø¬Ø¨ 1447</strong> Ø­ØªÙ‰ <strong>Ù†Ù‡Ø§ÙŠØ© Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ 1448</strong>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="status-bar">
      <div id="adminStatus" class="status-badge status-visitor">
        ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·
      </div>
      <div class="controls">
        <button id="adminToggleBtn" onclick="toggleAdmin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="secondary" onclick="changeAdminPassword()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="secondary" onclick="printCalendar()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</button>
        <button class="secondary" onclick="exportPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
        <button class="secondary" onclick="downloadBackup()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <button class="secondary" onclick="triggerRestore()">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ± -->
    <div class="filter-row">
      <span>ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ:</span>
      <input type="text" id="filterInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø¥Ø¬Ø§Ø²Ø©ØŒ Ù†Ø´Ø§Ø·..." />
      <button onclick="applyFilter()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
      <button class="secondary" onclick="clearFilter()">Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±</button>
    </div>

    <!-- Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div class="legend">
      <span><span class="legend-color" style="background:#e53935;"></span> Ø£Ø­Ù…Ø± = Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</span>
      <span><span class="legend-color" style="background:#43a047;"></span> Ø£Ø®Ø¶Ø± = Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø© Ø³Ø¹ÙŠØ¯Ø©</span>
      <span><span class="legend-color" style="background:#1e88e5;"></span> Ø£Ø²Ø±Ù‚ = Ù…Ø­Ø§Ø¶Ø±Ø© / Ø¯ÙˆØ±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</span>
      <span><span class="legend-color" style="background:#fb8c00;"></span> Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ = Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</span>
      <span><span class="legend-color" style="background:#8e24aa;"></span> Ø¨Ù†ÙØ³Ø¬ÙŠ = ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</span>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø´Ù‡Ø± -->
    <div id="calendarContainer"></div>

    <div class="hint">
      ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
      <br />â€“ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· (ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: <strong>1234</strong>).
      <br />â€“ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„Ø­Ø¯Ø« (Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©) Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©ØŒ ÙˆØ³ÙŠØªÙ… ØªÙƒØ±Ø§Ø±Ù‡ Ø¹Ù„Ù‰ ØªÙ„Ùƒ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ù„ÙˆÙ† Ù…ØªØµÙ„.
      <br />â€“ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¯Ø« Ù„Ø¹Ø±Ø¶Ù‡ ÙƒØ§Ù…Ù„Ù‹Ø§ ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© (Ù„Ù„Ø²Ø§Ø¦Ø± ÙˆØ§Ù„Ù…Ø¯ÙŠØ±).
      <br />â€“ ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù…ØªØµÙØ­Ùƒ (localStorage)ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
    </div>
  </div>

  <!-- Ø­ÙˆØ§Ø± Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« -->
  <div id="eventDialog" class="dialog-backdrop dialog-hidden">
    <div class="dialog-box">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„ÙŠÙˆÙ…</h3>
      <div class="dialog-row">
        <div id="dialogDateLabel" style="font-size:12px;color:#6b7280;"></div>
      </div>
      <div class="dialog-row">
        <label for="eventTitleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«</label>
        <input type="text" id="eventTitleInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù…Ù„ÙŠØŒ Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©..." />
      </div>
      <div class="dialog-row">
        <label for="eventColorSelect">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«</label>
        <select id="eventColorSelect">
          <option value="#e53935">Ø£Ø­Ù…Ø± â€“ Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</option>
          <option value="#43a047">Ø£Ø®Ø¶Ø± â€“ Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø©</option>
          <option value="#1e88e5">Ø£Ø²Ø±Ù‚ â€“ Ù…Ø­Ø§Ø¶Ø±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</option>
          <option value="#fb8c00">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ â€“ Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</option>
          <option value="#8e24aa">Ø¨Ù†ÙØ³Ø¬ÙŠ â€“ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</option>
        </select>
      </div>
      <div class="dialog-row">
        <label for="eventRepeatDays">Ù…Ø¯Ø© Ø§Ù„Ø­Ø¯Ø« (Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØªØ§Ù„ÙŠØ©ØŒ 0 = ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)</label>
        <input type="number" id="eventRepeatDays" min="0" max="100" value="0" />
      </div>
      <div class="dialog-actions">
        <button onclick="saveEventFromDialog()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="secondary" onclick="closeEventDialog()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ø­ÙˆØ§Ø± Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« -->
  <div id="eventViewDialog" class="dialog-backdrop dialog-hidden">
    <div class="dialog-box">
      <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«</h3>
      <div id="viewDateLabel" class="event-view-date"></div>
      <div id="viewText" class="event-view-text"></div>
      <div class="dialog-actions">
        <button class="secondary" onclick="closeEventViewDialog()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
  <input type="file" id="backupFileInput" accept="application/json" style="display:none" />

  <script>
    /**********************
     * Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰)
     **********************/
    const WEEKDAYS = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

    const HIJRI_MONTHS = [
      { year: 1447, month: 7,  name: "Ø±Ø¬Ø¨",        days: 30, startWeekday: 0 }, // 1 Ø±Ø¬Ø¨ = Ø§Ù„Ø£Ø­Ø¯
      { year: 1447, month: 8,  name: "Ø´Ø¹Ø¨Ø§Ù†",      days: 30, startWeekday: 2 }, // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡
      { year: 1447, month: 9,  name: "Ø±Ù…Ø¶Ø§Ù†",      days: 29, startWeekday: 4 }, // Ø§Ù„Ø®Ù…ÙŠØ³
      { year: 1447, month: 10, name: "Ø´ÙˆØ§Ù„",       days: 30, startWeekday: 5 }, // Ø§Ù„Ø¬Ù…Ø¹Ø©
      { year: 1447, month: 11, name: "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©",  days: 29, startWeekday: 0 }, // Ø§Ù„Ø£Ø­Ø¯
      { year: 1447, month: 12, name: "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©",   days: 29, startWeekday: 1 }, // Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†
      { year: 1448, month: 1,  name: "Ù…Ø­Ø±Ù…",       days: 30, startWeekday: 2 }, // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡
      { year: 1448, month: 2,  name: "ØµÙØ±",        days: 29, startWeekday: 4 }, // Ø§Ù„Ø®Ù…ÙŠØ³
      { year: 1448, month: 3,  name: "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„", days: 29, startWeekday: 5 }  // Ø§Ù„Ø¬Ù…Ø¹Ø©
    ];

    const RANGE_START = { year: 1447, month: 7, day: 29 };
    const RANGE_END   = { year: 1448, month: 3, day: 29 };

    const ADMIN_DEFAULT_PASSWORD = "1234";
    const ADMIN_PASSWORD_KEY = "CAL_ADMIN_PWD_V1";
    const EVENTS_STORAGE_KEY = "CAL_EVENTS_V3";

    let isAdmin = false;
    let events = {};
    let currentFilter = "";

    /********* ØªÙˆØ§Ø¨Ø¹ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù‡Ø¬Ø±ÙŠ *********/
    function compareHijri(a, b) {
      if (a.year !== b.year) return a.year - b.year;
      if (a.month !== b.month) return a.month - b.month;
      return a.day - b.day;
    }

    function inRange(dayObj) {
      return compareHijri(dayObj, RANGE_START) >= 0 && compareHijri(dayObj, RANGE_END) <= 0;
    }

    function findMonthIndex(year, month) {
      return HIJRI_MONTHS.findIndex(m => m.year === year && m.month === month);
    }

    function getPrevMonthByYM(year, month) {
      const idx = findMonthIndex(year, month);
      if (idx <= 0) return null;
      const prev = HIJRI_MONTHS[idx - 1];
      return { year: prev.year, month: prev.month, days: prev.days };
    }

    function getNextMonthByYM(year, month) {
      const idx = findMonthIndex(year, month);
      if (idx === -1 || idx >= HIJRI_MONTHS.length - 1) return null;
      const next = HIJRI_MONTHS[idx + 1];
      return { year: next.year, month: next.month, days: next.days };
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£ÙŠØ§Ù… (Ù„Ù„Ø£Ù…Ø§Ù… ÙÙ‚Ø·) Ø¶Ù…Ù† Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    function addHijriDays(start, offset) {
      let y = start.year;
      let m = start.month;
      let d = start.day + offset;

      while (true) {
        const idx = findMonthIndex(y, m);
        if (idx === -1) return null;
        const monthInfo = HIJRI_MONTHS[idx];
        if (d <= monthInfo.days) break;
        d -= monthInfo.days;
        const next = getNextMonthByYM(y, m);
        if (!next) return null;
        y = next.year;
        m = next.month;
      }

      return { year: y, month: m, day: d };
    }

    function makeKey(year, month, day) {
      return `${year}-${month}-${day}`;
    }

    /********* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠØ± *********/
    function getAdminPassword() {
      return localStorage.getItem(ADMIN_PASSWORD_KEY) || ADMIN_DEFAULT_PASSWORD;
    }

    function toggleAdmin() {
      if (isAdmin) {
        isAdmin = false;
        updateAdminStatus();
        renderCalendar();
        return;
      }
      const input = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 1234):");
      if (input === null) return;
      if (input === getAdminPassword()) {
        isAdmin = true;
        updateAdminStatus();
        renderCalendar();
      } else {
        alert("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      }
    }

    function changeAdminPassword() {
      if (!isAdmin) {
        alert("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
        return;
      }
      const current = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
      if (current === null) return;
      if (current !== getAdminPassword()) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        return;
      }
      const newPwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„):");
      if (!newPwd || newPwd.length < 4) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹.");
        return;
      }
      const confirmPwd = prompt("Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
      if (confirmPwd !== newPwd) {
        alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
        return;
      }
      localStorage.setItem(ADMIN_PASSWORD_KEY, newPwd);
      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
    }

    function updateAdminStatus() {
      const badge = document.getElementById("adminStatus");
      const btn = document.getElementById("adminToggleBtn");
      if (isAdmin) {
        badge.classList.remove("status-visitor");
        badge.classList.add("status-admin");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± â€“ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø«";
        btn.textContent = "ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¯ÙŠØ±";
      } else {
        badge.classList.remove("status-admin");
        badge.classList.add("status-visitor");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·";
        btn.textContent = "ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±";
      }
    }

    /********* ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« *********/
    function loadEvents() {
      try {
        const raw = localStorage.getItem(EVENTS_STORAGE_KEY);
        events = raw ? JSON.parse(raw) : {};
      } catch {
        events = {};
      }
    }

    function saveEvents() {
      localStorage.setItem(EVENTS_STORAGE_KEY, JSON.stringify(events));
    }

    /********* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… *********/
    function renderCalendar() {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      HIJRI_MONTHS.forEach((m) => {
        const monthCard = document.createElement("div");
        monthCard.className = "month-card";

        const header = document.createElement("div");
        header.className = "month-header";

        const nameSpan = document.createElement("div");
        nameSpan.className = "month-name";
        nameSpan.textContent = `${m.name} ${m.year} Ù‡Ù€`;

        const rangeSpan = document.createElement("div");
        rangeSpan.className = "month-range";

        let firstVisibleDay = 1;
        if (compareHijri({year:m.year,month:m.month,day:1}, RANGE_START) < 0) {
          firstVisibleDay = RANGE_START.day;
        }
        let lastVisibleDay = m.days;
        if (compareHijri({year:m.year,month:m.month,day:m.days}, RANGE_END) > 0) {
          lastVisibleDay = RANGE_END.day;
        }
        rangeSpan.textContent = `Ù…Ù† ${firstVisibleDay} Ø¥Ù„Ù‰ ${lastVisibleDay} ${m.name}`;

        header.appendChild(nameSpan);
        header.appendChild(rangeSpan);
        monthCard.appendChild(header);

        const body = document.createElement("div");
        body.className = "month-body";

        const table = document.createElement("table");
        table.className = "month-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        WEEKDAYS.forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const prevMonth = getPrevMonthByYM(m.year, m.month);
        const nextMonth = getNextMonthByYM(m.year, m.month);

        let dayNum = 1;
        let nextMonthDay = 1;

        for (let week = 0; week < 6; week++) {
          const row = document.createElement("tr");

          for (let wd = 0; wd < 7; wd++) {
            const cell = document.createElement("td");
            let cellDay, cellMonth, cellYear, isPrevNext = false;

            const cellIndex = week * 7 + wd;

            if (cellIndex < m.startWeekday) {
              if (prevMonth) {
                const prevDays = prevMonth.days;
                const offset = m.startWeekday - cellIndex;
                cellDay = prevDays - offset + 1;
                cellMonth = prevMonth.month;
                cellYear = prevMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            } else if (dayNum <= m.days) {
              cellDay = dayNum++;
              cellMonth = m.month;
              cellYear = m.year;
            } else {
              if (nextMonth) {
                cellDay = nextMonthDay++;
                cellMonth = nextMonth.month;
                cellYear = nextMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            }

            const dayObj = { year: cellYear, month: cellMonth, day: cellDay };
            const insideRange = inRange(dayObj);

            if (!insideRange) {
              cell.classList.add("out-of-range");
            } else if (isPrevNext) {
              cell.classList.add("prev-next");
            }

            const dn = document.createElement("div");
            dn.className = "day-number";
            dn.textContent = cellDay;
            cell.appendChild(dn);

            const evList = document.createElement("div");
            evList.className = "event-list";

            const key = makeKey(cellYear, cellMonth, cellDay);
            let dayEvents = events[key] || [];

            if (currentFilter) {
              dayEvents = dayEvents.filter(ev =>
                (ev.text || "").toLowerCase().includes(currentFilter.toLowerCase())
              );
            }

            dayEvents.forEach(ev => {
              const pill = document.createElement("div");
              pill.className = "event-pill";
              pill.style.background = ev.color || "#2563eb";

              // Ø´ÙƒÙ„ Ø§Ù„Ø´Ø±ÙŠØ· Ø­Ø³Ø¨ Ù…ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¯Ù‰
              if (ev.pos) {
                pill.classList.add("range-" + ev.pos);
              } else {
                pill.classList.add("range-single");
              }

              const txt = document.createElement("span");
              txt.className = "event-text";
              // Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙÙ‚Ø· ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« Ù…ÙØ±Ø¯
              if (!ev.pos || ev.pos === "single" || ev.pos === "start") {
                txt.textContent = ev.text || "";
              } else {
                txt.textContent = ""; // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©/Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù†Øµ Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù„ÙˆÙ†ÙŠ
              }

              // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ (Ù„Ù„Ø¬Ù…ÙŠØ¹)
              txt.onclick = (e) => {
                e.stopPropagation();
                const [yy,mm,dd] = key.split("-").map(Number);
                viewEvent({year:yy,month:mm,day:dd}, ev);
              };

              pill.appendChild(txt);

              const del = document.createElement("span");
              del.className = "event-delete";
              del.textContent = "Ã—";
              if (isAdmin) {
                del.onclick = (e) => {
                  e.stopPropagation();
                  deleteEvent(key, ev.id);
                };
              } else {
                del.classList.add("disabled");
              }
              pill.appendChild(del);

              evList.appendChild(pill);
            });

            cell.appendChild(evList);

            if (insideRange) {
              cell.onclick = () => handleDayClick(dayObj);
            }

            row.appendChild(cell);
          }

          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        body.appendChild(table);
        monthCard.appendChild(body);
        container.appendChild(monthCard);
      });
    }

    /********* Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« *********/
    let dialogDate = null;

    function handleDayClick(dayObj) {
      if (!isAdmin) {
        alert("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø®ØµØµØ© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·.");
        return;
      }
      dialogDate = dayObj;
      openEventDialog(dayObj);
    }

    function openEventDialog(dayObj) {
      const label = document.getElementById("dialogDateLabel");
      label.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dayObj.day} / ${dayObj.month} / ${dayObj.year} Ù‡Ù€`;

      document.getElementById("eventTitleInput").value = "";
      document.getElementById("eventColorSelect").value = "#e53935";
      document.getElementById("eventRepeatDays").value = "0";

      document.getElementById("eventDialog").classList.remove("dialog-hidden");
    }

    function closeEventDialog() {
      document.getElementById("eventDialog").classList.add("dialog-hidden");
      dialogDate = null;
    }

    function saveEventFromDialog() {
      if (!dialogDate) {
        closeEventDialog();
        return;
      }
      const title = document.getElementById("eventTitleInput").value.trim();
      const color = document.getElementById("eventColorSelect").value;
      let repeatDays = parseInt(document.getElementById("eventRepeatDays").value || "0", 10);
      if (isNaN(repeatDays) || repeatDays < 0) repeatDays = 0;

      if (!title) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«.");
        return;
      }

      const groupId = "grp_" + Date.now().toString(36) + Math.random().toString(16).slice(2);
      const totalDays = repeatDays + 1;

      for (let i = 0; i < totalDays; i++) {
        const d = addHijriDays(dialogDate, i);
        if (!d || !inRange(d)) continue;
        const key = makeKey(d.year, d.month, d.day);
        if (!events[key]) events[key] = [];

        let pos = "single";
        if (totalDays === 1) {
          pos = "single";
        } else if (i === 0) {
          pos = "start";
        } else if (i === totalDays - 1) {
          pos = "end";
        } else {
          pos = "mid";
        }

        events[key].push({
          id: groupId + "_" + i,
          groupId: groupId,
          text: title,
          color: color,
          pos: pos
        });
      }

      saveEvents();
      renderCalendar();
      closeEventDialog();
    }

    /********* Ø­Ø°Ù Ø­Ø¯Ø« *********/
    function deleteEvent(key, id) {
      if (!isAdmin) {
        alert("Ø­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
        return;
      }
      if (!events[key]) return;
      events[key] = events[key].filter(ev => ev.id !== id);
      if (events[key].length === 0) {
        delete events[key];
      }
      saveEvents();
      renderCalendar();
    }

    /********* Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« (Ù„Ù„Ø¬Ù…ÙŠØ¹) *********/
    function viewEvent(dayObj, ev) {
      const dateLabel = document.getElementById("viewDateLabel");
      const textBox = document.getElementById("viewText");
      dateLabel.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dayObj.day} / ${dayObj.month} / ${dayObj.year} Ù‡Ù€`;
      textBox.textContent = ev.text || "";
      document.getElementById("eventViewDialog").classList.remove("dialog-hidden");
    }

    function closeEventViewDialog() {
      document.getElementById("eventViewDialog").classList.add("dialog-hidden");
    }

    /********* Ø§Ù„ÙÙ„ØªØ± *********/
    function applyFilter() {
      const inp = document.getElementById("filterInput");
      currentFilter = inp.value.trim();
      renderCalendar();
    }

    function clearFilter() {
      document.getElementById("filterInput").value = "";
      currentFilter = "";
      renderCalendar();
    }

    /********* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ùˆ PDF *********/
    function printCalendar() {
      window.print();
    }

    function exportPDF() {
      const element = document.querySelector(".page");
      const opt = {
        margin:       0.5,
        filename:     "calendar-1447-1448-ummalqura.pdf",
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: "cm", format: "a4", orientation: "landscape" }
      };
      html2pdf().from(element).set(opt).save();
    }

    /********* Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© *********/
    function downloadBackup() {
      const dataStr = JSON.stringify(events, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "calendar-events-backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerRestore() {
      document.getElementById("backupFileInput").click();
    }

    document.getElementById("backupFileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = JSON.parse(evt.target.result);
          if (typeof data !== "object" || Array.isArray(data)) {
            throw new Error("bad");
          }
          events = data;
          saveEvents();
          renderCalendar();
          alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (err) {
          alert("ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ­ÙŠØ­.");
        } finally {
          e.target.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    });

    /********* ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ *********/
    loadEvents();
    updateAdminStatus();
    renderCalendar();
  </script>
</body>
</html>
