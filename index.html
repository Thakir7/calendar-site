<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ 1447â€“1448 | Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø«</title>
  <!-- Ù…ÙƒØªØ¨Ø© ØªØµØ¯ÙŠØ± PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Tahoma", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 20px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      margin: 0 0 10px;
      font-size: 24px;
    }

    .subtitle {
      text-align: center;
      margin-bottom: 15px;
      color: #6b7280;
      font-size: 14px;
    }

    .status-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-visitor {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-admin {
      background: #dcfce7;
      color: #166534;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
    }

    button.secondary {
      background: #6b7280;
    }

    button.danger {
      background: #b91c1c;
    }

    button.small {
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 999px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 15px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .filter-row input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .legend {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-inline-start: 8px;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #9ca3af;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø´Ù‡Ø± */
    #calendarContainer {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .month-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      min-height: 280px;
    }

    .month-header {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      background: #f3f4ff;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .month-name {
      font-weight: bold;
      font-size: 14px;
    }

    .month-range {
      font-size: 11px;
      color: #6b7280;
    }

    .month-body {
      padding: 6px;
      flex: 1;
    }

    table.month-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }

    .month-table th {
      padding: 4px 2px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: bold;
      color: #6b7280;
      text-align: center;
    }

    .month-table td {
      border: 1px solid #f3f4f6;
      vertical-align: top;
      height: 52px;
      padding: 2px;
      position: relative;
      cursor: pointer;
      background: #ffffff;
    }

    .month-table td.out-of-range {
      background: #f9fafb;
      color: #9ca3af;
      cursor: default;
    }

    .month-table td.prev-next {
      background: #f9fafb;
      color: #9ca3af;
    }

    .day-number {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .event-list {
      max-height: 40px;
      overflow: hidden auto;
    }

    .event-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 999px;
      padding: 1px 4px;
      margin-bottom: 2px;
      font-size: 10px;
      color: #ffffff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-delete {
      margin-right: 4px;
      margin-left: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    .event-delete.disabled {
      cursor: default;
      opacity: 0.5;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    /* Ø­ÙˆØ§Ø± Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¯Ø« */
    .dialog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .dialog-hidden {
      display: none;
    }

    .dialog-box {
      background: #ffffff;
      padding: 16px 18px;
      border-radius: 10px;
      width: 320px;
      max-width: 95vw;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      font-size: 13px;
    }

    .dialog-box h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .dialog-row {
      margin-bottom: 8px;
    }

    .dialog-row label {
      display: block;
      margin-bottom: 3px;
      font-size: 12px;
    }

    .dialog-row input,
    .dialog-row select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .dialog-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 900px) {
      #calendarContainer {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .page {
        margin: 0;
        border-radius: 0;
        box-shadow: none;
      }
      #calendarContainer {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }

    /* ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    @media print {
      body {
        background: #ffffff;
      }
      .page {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
      }
      .status-bar,
      .filter-row,
      .legend,
      .hint,
      .dialog-backdrop {
        display: none !important;
      }
      button {
        display: none !important;
      }
      #calendarContainer {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      .month-card {
        border: 1px solid #d1d5db;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ (Ù‡Ø¬Ø±ÙŠ) Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h1>
    <div class="subtitle">
      Ø§Ù„ÙØªØ±Ø© Ù…Ù† <strong>27 Ø±Ø¬Ø¨ 1447</strong> Ø­ØªÙ‰ <strong>Ù†Ù‡Ø§ÙŠØ© Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ 1448</strong>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="status-bar">
      <div id="adminStatus" class="status-badge status-visitor">
        ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·
      </div>
      <div class="controls">
        <button id="adminToggleBtn" onclick="toggleAdmin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="secondary" onclick="changeAdminPassword()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="secondary" onclick="printCalendar()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…</button>
        <button class="secondary" onclick="exportPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
        <button class="secondary" onclick="downloadBackup()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <button class="secondary" onclick="triggerRestore()">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ± -->
    <div class="filter-row">
      <span>ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ:</span>
      <input type="text" id="filterInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø¥Ø¬Ø§Ø²Ø©ØŒ Ù†Ø´Ø§Ø·..." />
      <button onclick="applyFilter()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
      <button class="secondary" onclick="clearFilter()">Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±</button>
    </div>

    <!-- Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div class="legend">
      <span><span class="legend-color" style="background:#e53935;"></span> Ø£Ø­Ù…Ø± = Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</span>
      <span><span class="legend-color" style="background:#43a047;"></span> Ø£Ø®Ø¶Ø± = Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø© Ø³Ø¹ÙŠØ¯Ø©</span>
      <span><span class="legend-color" style="background:#1e88e5;"></span> Ø£Ø²Ø±Ù‚ = Ù…Ø­Ø§Ø¶Ø±Ø© / Ø¯ÙˆØ±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</span>
      <span><span class="legend-color" style="background:#fb8c00;"></span> Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ = Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</span>
      <span><span class="legend-color" style="background:#8e24aa;"></span> Ø¨Ù†ÙØ³Ø¬ÙŠ = ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</span>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø´Ù‡Ø± -->
    <div id="calendarContainer"></div>

    <div class="hint">
      ğŸ“Œ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
      <br />â€“ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· (ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: <strong>1234</strong>).
      <br />â€“ ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ù…ØªØµÙØ­Ùƒ (localStorage)ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.
    </div>
  </div>

  <!-- Ø­ÙˆØ§Ø± Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¯Ø« -->
  <div id="eventDialog" class="dialog-backdrop dialog-hidden">
    <div class="dialog-box">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ù„Ù„ÙŠÙˆÙ…</h3>
      <div class="dialog-row">
        <div id="dialogDateLabel" style="font-size:12px;color:#6b7280;"></div>
      </div>
      <div class="dialog-row">
        <label for="eventTitleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«</label>
        <input type="text" id="eventTitleInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù…Ù„ÙŠØŒ Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©..." />
      </div>
      <div class="dialog-row">
        <label for="eventColorSelect">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«</label>
        <select id="eventColorSelect">
          <option value="#e53935">Ø£Ø­Ù…Ø± â€“ Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</option>
          <option value="#43a047">Ø£Ø®Ø¶Ø± â€“ Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø©</option>
          <option value="#1e88e5">Ø£Ø²Ø±Ù‚ â€“ Ù…Ø­Ø§Ø¶Ø±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</option>
          <option value="#fb8c00">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ â€“ Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</option>
          <option value="#8e24aa">Ø¨Ù†ÙØ³Ø¬ÙŠ â€“ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</option>
        </select>
      </div>
      <div class="dialog-actions">
        <button onclick="saveEventFromDialog()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="secondary" onclick="closeEventDialog()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¯Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
  <input type="file" id="backupFileInput" accept="application/json" style="display:none" />

  <script>
    /**********************
     * Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ
     * (Ø­Ø³Ø¨ ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©)
     * Ø§Ù„Ù…ØµØ¯Ø±: Ø¬Ø¯Ø§ÙˆÙ„ 1447 Ùˆ1448 (Habibur Hijri Calendar Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Umm al-Qura) :contentReference[oaicite:1]{index=1}
     **********************/

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙŠØ§Ù…: 0=Ø§Ù„Ø£Ø­Ø¯ ... 6=Ø§Ù„Ø³Ø¨Øª
    const WEEKDAYS = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

    // Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‡Ø¬Ø±ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø· (Ù…Ù† 7/1447 Ø¥Ù„Ù‰ 3/1448)
    const HIJRI_MONTHS = [
      { year: 1447, month: 7,  name: "Ø±Ø¬Ø¨",        days: 30, startWeekday: 0 }, // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø£Ø­Ø¯
      { year: 1447, month: 8,  name: "Ø´Ø¹Ø¨Ø§Ù†",     days: 30, startWeekday: 2 }, // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡
      { year: 1447, month: 9,  name: "Ø±Ù…Ø¶Ø§Ù†",     days: 29, startWeekday: 4 }, // Ø§Ù„Ø®Ù…ÙŠØ³
      { year: 1447, month: 10, name: "Ø´ÙˆØ§Ù„",      days: 30, startWeekday: 5 }, // Ø§Ù„Ø¬Ù…Ø¹Ø©
      { year: 1447, month: 11, name: "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©", days: 29, startWeekday: 0 }, // Ø§Ù„Ø£Ø­Ø¯
      { year: 1447, month: 12, name: "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©",  days: 29, startWeekday: 1 }, // Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†
      { year: 1448, month: 1,  name: "Ù…Ø­Ø±Ù…",      days: 30, startWeekday: 2 }, // Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡
      { year: 1448, month: 2,  name: "ØµÙØ±",       days: 29, startWeekday: 4 }, // Ø§Ù„Ø®Ù…ÙŠØ³
      { year: 1448, month: 3,  name: "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„",days: 29, startWeekday: 5 }  // Ø§Ù„Ø¬Ù…Ø¹Ø©
    ];

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const RANGE_START = { year: 1447, month: 7, day: 29 };
    const RANGE_END   = { year: 1448, month: 3, day: 29 }; // Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ 1448

    /**********************
     * Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
     **********************/
    const ADMIN_DEFAULT_PASSWORD = "1234";
    const ADMIN_PASSWORD_KEY = "CAL_ADMIN_PWD_V1";
    const EVENTS_STORAGE_KEY = "CAL_EVENTS_V3";

    let isAdmin = false;
    let events = {}; // { "1447-7-27": [ {id,text,color}, ... ] }
    let currentFilter = "";

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠØ© (Ø³Ù†Ø©/Ø´Ù‡Ø±/ÙŠÙˆÙ…)
    function compareHijri(a, b) {
      if (a.year !== b.year) return a.year - b.year;
      if (a.month !== b.month) return a.month - b.month;
      return a.day - b.day;
    }

    function inRange(dayObj) {
      return compareHijri(dayObj, RANGE_START) >= 0 && compareHijri(dayObj, RANGE_END) <= 0;
    }

    function getAdminPassword() {
      return localStorage.getItem(ADMIN_PASSWORD_KEY) || ADMIN_DEFAULT_PASSWORD;
    }

    function toggleAdmin() {
      if (isAdmin) {
        isAdmin = false;
        updateAdminStatus();
        renderCalendar();
        return;
      }
      const input = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 1234):");
      if (input === null) return;
      if (input === getAdminPassword()) {
        isAdmin = true;
        updateAdminStatus();
        renderCalendar();
      } else {
        alert("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      }
    }

    function changeAdminPassword() {
      if (!isAdmin) {
        alert("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
        return;
      }
      const current = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
      if (current === null) return;
      if (current !== getAdminPassword()) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        return;
      }
      const newPwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„):");
      if (!newPwd || newPwd.length < 4) {
        alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹.");
        return;
      }
      const confirmPwd = prompt("Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
      if (confirmPwd !== newPwd) {
        alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
        return;
      }
      localStorage.setItem(ADMIN_PASSWORD_KEY, newPwd);
      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
    }

    function updateAdminStatus() {
      const badge = document.getElementById("adminStatus");
      const btn = document.getElementById("adminToggleBtn");
      if (isAdmin) {
        badge.classList.remove("status-visitor");
        badge.classList.add("status-admin");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± â€“ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø«";
        btn.textContent = "ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¯ÙŠØ±";
      } else {
        badge.classList.remove("status-admin");
        badge.classList.add("status-visitor");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·";
        btn.textContent = "ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±";
      }
    }

    /**********************
     * ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
     **********************/
    function loadEvents() {
      try {
        const raw = localStorage.getItem(EVENTS_STORAGE_KEY);
        events = raw ? JSON.parse(raw) : {};
      } catch {
        events = {};
      }
    }

    function saveEvents() {
      localStorage.setItem(EVENTS_STORAGE_KEY, JSON.stringify(events));
    }

    function makeKey(year, month, day) {
      return `${year}-${month}-${day}`;
    }

    /**********************
     * Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
     **********************/
    function renderCalendar() {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      HIJRI_MONTHS.forEach((m, index) => {
        const monthCard = document.createElement("div");
        monthCard.className = "month-card";

        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ù‡Ø±
        const header = document.createElement("div");
        header.className = "month-header";

        const nameSpan = document.createElement("div");
        nameSpan.className = "month-name";
        nameSpan.textContent = `${m.name} ${m.year} Ù‡Ù€`;

        const rangeSpan = document.createElement("div");
        rangeSpan.className = "month-range";

        // ÙˆØµÙ Ø¨Ø³ÙŠØ· Ù„Ù„ÙØªØ±Ø© Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù…Ø§ ÙŠÙˆØ§ÙÙ‚ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
        let firstVisibleDay = 1;
        if (compareHijri({year:m.year,month:m.month,day:1}, RANGE_START) < 0) {
          firstVisibleDay = RANGE_START.day;
        }
        let lastVisibleDay = m.days;
        if (compareHijri({year:m.year,month:m.month,day:m.days}, RANGE_END) > 0) {
          lastVisibleDay = RANGE_END.day;
        }
        rangeSpan.textContent = `Ù…Ù† ${firstVisibleDay} Ø¥Ù„Ù‰ ${lastVisibleDay} ${m.name}`;

        header.appendChild(nameSpan);
        header.appendChild(rangeSpan);
        monthCard.appendChild(header);

        const body = document.createElement("div");
        body.className = "month-body";

        const table = document.createElement("table");
        table.className = "month-table";

        // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£ÙŠØ§Ù…
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        WEEKDAYS.forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ù„Ø§Ø­Ù‚Ø© (Ù…Ø«Ù„ Ø´ÙƒÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
        const prevMonth = getPreviousMonth(index);
        const nextMonth = getNextMonth(index);

        const totalCells = 6 * 7; // 6 Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        let dayNum = 1;
        let nextMonthDay = 1;

        for (let week = 0; week < 6; week++) {
          const row = document.createElement("tr");
          for (let wd = 0; wd < 7; wd++) {
            const cell = document.createElement("td");
            let cellDay, cellMonth, cellYear, isCurrent = false, isPrevNext = false;

            const cellIndex = week * 7 + wd;

            if (cellIndex < m.startWeekday) {
              // Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
              if (prevMonth) {
                const prevDays = prevMonth.days;
                const offset = m.startWeekday - cellIndex;
                cellDay = prevDays - offset + 1;
                cellMonth = prevMonth.month;
                cellYear = prevMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            } else if (dayNum <= m.days) {
              // Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
              cellDay = dayNum++;
              cellMonth = m.month;
              cellYear = m.year;
              isCurrent = true;
            } else {
              // Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ
              if (nextMonth) {
                cellDay = nextMonthDay++;
                cellMonth = nextMonth.month;
                cellYear = nextMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            }

            const dayObj = { year: cellYear, month: cellMonth, day: cellDay };

            // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const insideRange = inRange(dayObj);

            if (!insideRange) {
              cell.classList.add("out-of-range");
            } else if (isPrevNext) {
              // Ø£ÙŠØ§Ù… Ù…Ù† Ø´Ù‡Ø± Ø¢Ø®Ø± Ù„ÙƒÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ (Ù…Ø«Ù„ 27â€“30 Ø±Ø¬Ø¨ Ø¯Ø§Ø®Ù„ Ù…Ø±Ø¨Ø¹ Ø´Ø¹Ø¨Ø§Ù†)
              cell.classList.add("prev-next");
            }

            // Ø±Ù‚Ù… Ø§Ù„ÙŠÙˆÙ…
            const dn = document.createElement("div");
            dn.className = "day-number";
            dn.textContent = cellDay;
            cell.appendChild(dn);

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            const evList = document.createElement("div");
            evList.className = "event-list";

            const key = makeKey(cellYear, cellMonth, cellDay);
            let dayEvents = events[key] || [];

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
            if (currentFilter) {
              dayEvents = dayEvents.filter(ev =>
                (ev.text || "").toLowerCase().includes(currentFilter.toLowerCase())
              );
            }

            dayEvents.forEach(ev => {
              const pill = document.createElement("div");
              pill.className = "event-pill";
              pill.style.background = ev.color || "#2563eb";

              const txt = document.createElement("span");
              txt.className = "event-text";
              txt.textContent = ev.text || "";
              pill.appendChild(txt);

              const del = document.createElement("span");
              del.className = "event-delete";
              del.textContent = "Ã—";
              if (isAdmin) {
                del.onclick = (e) => {
                  e.stopPropagation();
                  deleteEvent(key, ev.id);
                };
              } else {
                del.classList.add("disabled");
              }
              pill.appendChild(del);

              evList.appendChild(pill);
            });

            cell.appendChild(evList);

            // Ø§Ù„Ù†Ù‚Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« (Ù„Ù„Ø£ÙŠØ§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© ÙÙ‚Ø·)
            if (insideRange) {
              cell.onclick = () => handleDayClick(dayObj);
            }

            row.appendChild(cell);
          }
          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        body.appendChild(table);
        monthCard.appendChild(body);
        container.appendChild(monthCard);
      });
    }

    function getPreviousMonth(index) {
      if (index <= 0) return null;
      return HIJRI_MONTHS[index - 1];
    }

    function getNextMonth(index) {
      if (index >= HIJRI_MONTHS.length - 1) return null;
      return HIJRI_MONTHS[index + 1];
    }

    /**********************
     * Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø«
     **********************/
    let dialogDate = null; // {year,month,day}

    function handleDayClick(dayObj) {
      if (!isAdmin) {
        alert("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø®ØµØµØ© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·.");
        return;
      }
      dialogDate = dayObj;
      openEventDialog(dayObj);
    }

    function openEventDialog(dayObj) {
      const label = document.getElementById("dialogDateLabel");
      label.textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dayObj.day} / ${dayObj.month} / ${dayObj.year} Ù‡Ù€`;

      document.getElementById("eventTitleInput").value = "";
      document.getElementById("eventColorSelect").value = "#e53935";

      document.getElementById("eventDialog").classList.remove("dialog-hidden");
    }

    function closeEventDialog() {
      document.getElementById("eventDialog").classList.add("dialog-hidden");
      dialogDate = null;
    }

    function saveEventFromDialog() {
      if (!dialogDate) {
        closeEventDialog();
        return;
      }
      const title = document.getElementById("eventTitleInput").value.trim();
      const color = document.getElementById("eventColorSelect").value;
      if (!title) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«.");
        return;
      }
      const key = makeKey(dialogDate.year, dialogDate.month, dialogDate.day);
      if (!events[key]) events[key] = [];
      events[key].push({
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        text: title,
        color: color
      });
      saveEvents();
      renderCalendar();
      closeEventDialog();
    }

    function deleteEvent(key, id) {
      if (!isAdmin) {
        alert("Ø­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
        return;
      }
      if (!events[key]) return;
      events[key] = events[key].filter(ev => ev.id !== id);
      if (events[key].length === 0) {
        delete events[key];
      }
      saveEvents();
      renderCalendar();
    }

    /**********************
     * Ø§Ù„ÙÙ„ØªØ±
     **********************/
    function applyFilter() {
      const inp = document.getElementById("filterInput");
      currentFilter = inp.value.trim();
      renderCalendar();
    }

    function clearFilter() {
      document.getElementById("filterInput").value = "";
      currentFilter = "";
      renderCalendar();
    }

    /**********************
     * Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ùˆ PDF
     **********************/
    function printCalendar() {
      window.print();
    }

    function exportPDF() {
      const element = document.querySelector(".page");
      const opt = {
        margin:       0.5,
        filename:     "calendar-1447-1448-ummalqura.pdf",
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: "cm", format: "a4", orientation: "landscape" }
      };
      html2pdf().from(element).set(opt).save();
    }

    /**********************
     * Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
     **********************/
    function downloadBackup() {
      const dataStr = JSON.stringify(events, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "calendar-events-backup.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerRestore() {
      document.getElementById("backupFileInput").click();
    }

    document.getElementById("backupFileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = JSON.parse(evt.target.result);
          if (typeof data !== "object" || Array.isArray(data)) {
            throw new Error("bad");
          }
          events = data;
          saveEvents();
          renderCalendar();
          alert("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.");
        } catch (err) {
          alert("ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ­ÙŠØ­.");
        } finally {
          e.target.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    });

    /**********************
     * ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
     **********************/
    loadEvents();
    updateAdminStatus();
    renderCalendar();
  </script>
</body>
</html>
