<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ 1447â€“1448 | Ø£Ø­Ø¯Ø§Ø« + Ø¹Ø¯Ù‘Ø§Ø¯</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    *{box-sizing:border-box;font-family:Tahoma, sans-serif}
    body{margin:0;padding:0;background:#f3f4f6;color:#111827}

    .page{
      max-width:1400px;margin:20px auto 40px;padding:20px;background:#fff;
      border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);
    }

    h1{margin:0 0 8px;text-align:center;font-size:24px}
    .subtitle{margin:0 0 12px;text-align:center;color:#6b7280;font-size:14px}

    .status-bar{
      display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:12px;padding:10px 12px;border-radius:8px;
      background:#f9fafb;border:1px solid #e5e7eb;font-size:13px
    }
    .status-badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:bold}
    .status-visitor{background:#fee2e2;color:#b91c1c}
    .status-admin{background:#dcfce7;color:#166534}

    .controls{display:flex;flex-wrap:wrap;gap:8px}
    button{
      border:none;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer;
      background:#2563eb;color:#fff
    }
    button.secondary{background:#6b7280}
    button.danger{background:#dc2626}
    button.small{padding:4px 8px;font-size:12px;border-radius:10px}
    button:disabled{opacity:.6;cursor:default}

    .filter-row{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;
      padding:8px 10px;border-radius:8px;background:#f9fafb;border:1px solid #e5e7eb;font-size:13px
    }
    .filter-row input[type="text"]{
      flex:1;min-width:180px;padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:13px
    }
    .filter-row select{
      padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:13px;
      background:#fff;
    }

    .legend{font-size:12px;color:#4b5563;margin-bottom:10px}
    .legend span{display:inline-flex;align-items:center;gap:4px;margin-inline-start:8px;margin-bottom:4px}
    .legend-color{width:14px;height:14px;border-radius:3px;border:1px solid #9ca3af}

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
    }

    #calendarContainer{
      display:grid;
      grid-template-columns: 1fr; /* Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯ ÙÙŠ ØµÙ */
      gap:12px;
    }

    .month-card{
      border-radius:10px;border:1px solid #e5e7eb;background:#fff;
      display:flex;flex-direction:column;min-height:280px;
    }
    .month-header{
      padding:8px 10px;border-bottom:1px solid #e5e7eb;background:#f3f4ff;
      display:flex;justify-content:space-between;align-items:baseline
    }
    .month-name{font-weight:bold;font-size:14px}
    .month-range{font-size:11px;color:#6b7280}
    .month-body{padding:6px;flex:1}

    table.month-table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:11px}
    .month-table th{
      padding:4px 2px;border-bottom:1px solid #e5e7eb;font-weight:bold;color:#6b7280;text-align:center
    }
    .month-table td{
      border:1px solid #f3f4f6;vertical-align:top;height:74px;padding:2px;position:relative;cursor:pointer;background:#fff
    }
    .month-table td.out-of-range{background:#f9fafb;color:#9ca3af;cursor:default}
    .month-table td.prev-next{background:#f9fafb;color:#9ca3af}
    .day-number{font-weight:bold;font-size:11px;margin-bottom:2px}

    .event-list{max-height:56px;overflow:hidden auto}

    .event-pill{
      display:flex;align-items:flex-start;justify-content:space-between;
      padding:2px 6px;margin-bottom:2px;font-size:11px;color:#fff;cursor:pointer;width:100%;gap:6px;
    }
    .event-text{flex:1;white-space:normal;line-height:1.2}
    .event-delete{font-weight:bold;cursor:pointer;flex-shrink:0}
    .event-delete.disabled{cursor:default;opacity:.5}

    /* Ø´Ø±ÙŠØ· Ù…ØªØµÙ„ Ù„Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ù…ØªØ¯Ø© */
    .event-pill.range-single{border-radius:999px}
    .event-pill.range-start{
      border-top-right-radius:999px;border-bottom-right-radius:999px;
      border-top-left-radius:0;border-bottom-left-radius:0;
    }
    .event-pill.range-mid{border-radius:0}
    .event-pill.range-end{
      border-top-left-radius:999px;border-bottom-left-radius:999px;
      border-top-right-radius:0;border-bottom-right-radius:0;
    }

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ */
    .today{
      outline:2px solid #16a34a;
      outline-offset:-2px;
      background:#ecfdf5 !important;
    }
    .today .day-number{
      background:#16a34a;color:#fff;border-radius:999px;padding:2px 6px;display:inline-block;
    }

    .sidebar{
      border:1px solid #e5e7eb;border-radius:10px;background:#fff;
      position:sticky; top:12px;
      overflow:hidden;
    }
    .sidebar-header{
      padding:10px 12px;background:#f9fafb;border-bottom:1px solid #e5e7eb;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .sidebar-title{font-weight:bold;font-size:13px}
    .sidebar-count{font-size:12px;color:#6b7280}
    .sidebar-body{padding:10px 12px;max-height:72vh;overflow:auto}

    .event-item{
      border:1px solid #e5e7eb;border-radius:10px;
      padding:8px 10px;margin-bottom:8px;background:#fff;
      cursor:pointer;
    }
    .event-item-top{display:flex;gap:8px;align-items:flex-start;justify-content:space-between}
    .event-left{display:flex;gap:8px;flex:1}
    .event-dot{width:10px;height:10px;border-radius:999px;margin-top:4px;flex-shrink:0}
    .event-item-title{font-weight:bold;font-size:13px;line-height:1.3}
    .event-item-dates{font-size:12px;color:#6b7280;margin-top:2px}
    .event-item-timer{
      margin-top:6px;padding:6px 8px;border-radius:8px;background:#f9fafb;border:1px solid #e5e7eb;font-size:12px;
    }
    .event-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    .timer-upcoming{color:#1d4ed8}
    .timer-ongoing{color:#166534}
    .timer-ended{color:#6b7280}

    .dialog-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;z-index:1000;
    }
    .dialog-hidden{display:none}
    .dialog-box{
      background:#fff;padding:16px 18px;border-radius:10px;width:360px;max-width:95vw;
      box-shadow:0 10px 25px rgba(0,0,0,.2);font-size:13px;
    }
    .dialog-box h3{margin:0 0 8px;font-size:16px}
    .dialog-row{margin-bottom:8px}
    .dialog-row label{display:block;margin-bottom:3px;font-size:12px}
    .dialog-row input,.dialog-row select{
      width:100%;padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:13px
    }
    .dialog-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
    .event-view-text{
      padding:8px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;font-size:13px;
      white-space:pre-wrap;max-height:240px;overflow:auto
    }
    .event-view-date{font-size:12px;color:#6b7280;margin-bottom:6px}

    .hint{font-size:11px;color:#6b7280;margin-top:10px}

    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr}
      .sidebar{position:static}
    }

    @media print{
      body{background:#fff}
      .page{box-shadow:none;margin:0;border-radius:0}
      .status-bar,.filter-row,.legend,.hint,.dialog-backdrop,.sidebar{display:none!important}
      button{display:none!important}
      #calendarContainer{grid-template-columns:1fr;gap:8px}
      .month-card{border:1px solid #d1d5db}
    }
  </style>
</head>

<body>
  <div class="page">
    <h1>ØªÙ‚ÙˆÙŠÙ… Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ (Ù‡Ø¬Ø±ÙŠ) Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« + Ø¹Ø¯Ù‘Ø§Ø¯</h1>
    <div class="subtitle">
      Ø§Ù„ÙØªØ±Ø© Ù…Ù† <strong>29 Ø±Ø¬Ø¨ 1447</strong> Ø­ØªÙ‰ <strong>Ù†Ù‡Ø§ÙŠØ© Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ 1448</strong>
    </div>

    <div class="status-bar">
      <div id="adminStatus" class="status-badge status-visitor">ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·</div>
      <div class="controls">
        <button id="adminToggleBtn" onclick="toggleAdmin()">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="secondary" onclick="changeAdminPassword()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        <button class="secondary" onclick="scrollToToday()">ğŸ“ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="secondary" onclick="printCalendar()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="secondary" onclick="exportPDF()">ğŸ“„ PDF</button>

        <!-- âœ… ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± -->
        <button id="backupBtn" class="secondary" onclick="downloadBackup()" style="display:none">ğŸ”„ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
        <button id="restoreBtn" class="secondary" onclick="triggerRestore()" style="display:none">â¬†ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
      </div>
    </div>

    <div class="filter-row">
      <span>ğŸ” ÙÙ„ØªØ±Ø©:</span>
      <input type="text" id="filterInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø¥Ø¬Ø§Ø²Ø©ØŒ Ù†Ø´Ø§Ø·..." />
      <span>â†•ï¸ ÙØ±Ø²:</span>
      <select id="sortSelect" onchange="renderAll()">
        <option value="date">Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</option>
        <option value="upcoming">Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹</option>
        <option value="ongoing">Ø§Ù„Ø¬Ø§Ø±ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹</option>
        <option value="ended">Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹</option>
      </select>
      <button onclick="applyFilter()">ØªØ·Ø¨ÙŠÙ‚</button>
      <button class="secondary" onclick="clearFilter()">Ù…Ø³Ø­</button>
    </div>

    <div class="legend">
      <span><span class="legend-color" style="background:#e53935;"></span> Ø£Ø­Ù…Ø± = Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</span>
      <span><span class="legend-color" style="background:#43a047;"></span> Ø£Ø®Ø¶Ø± = Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø©</span>
      <span><span class="legend-color" style="background:#1e88e5;"></span> Ø£Ø²Ø±Ù‚ = Ù…Ø­Ø§Ø¶Ø±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</span>
      <span><span class="legend-color" style="background:#fb8c00;"></span> Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ = Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</span>
      <span><span class="legend-color" style="background:#8e24aa;"></span> Ø¨Ù†ÙØ³Ø¬ÙŠ = ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</span>
    </div>

    <div class="layout">
      <div>
        <div id="calendarContainer"></div>
        <div class="hint">
          â€“ Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <b>1234</b>)<br/>
          â€“ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙŠØªØ­Ø¯Ø« Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„.
        </div>
      </div>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
          <div id="sidebarCount" class="sidebar-count">0</div>
        </div>
        <div id="eventsSidebar" class="sidebar-body"></div>
      </aside>
    </div>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« -->
  <div id="eventDialog" class="dialog-backdrop dialog-hidden">
    <div class="dialog-box">
      <h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø«</h3>
      <div class="dialog-row">
        <div id="dialogDateLabel" style="font-size:12px;color:#6b7280;"></div>
      </div>
      <div class="dialog-row">
        <label for="eventTitleInput">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«</label>
        <input type="text" id="eventTitleInput" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø±ØŒ Ø£Ø³Ø¨ÙˆØ¹ØŒ Ø¥Ø¬Ø§Ø²Ø©..." />
      </div>
      <div class="dialog-row">
        <label for="eventColorSelect">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯Ø«</label>
        <select id="eventColorSelect">
          <option value="#e53935">Ø£Ø­Ù…Ø± â€“ Ø§Ø®ØªØ¨Ø§Ø± / ØªØ­Ø°ÙŠØ±</option>
          <option value="#43a047">Ø£Ø®Ø¶Ø± â€“ Ø¥Ø¬Ø§Ø²Ø© / Ù…Ù†Ø§Ø³Ø¨Ø©</option>
          <option value="#1e88e5">Ø£Ø²Ø±Ù‚ â€“ Ù…Ø­Ø§Ø¶Ø±Ø© / Ø§Ø¬ØªÙ…Ø§Ø¹</option>
          <option value="#fb8c00">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ â€“ Ù…Ù‡Ù…Ø© / ØªØ³Ù„ÙŠÙ…</option>
          <option value="#8e24aa">Ø¨Ù†ÙØ³Ø¬ÙŠ â€“ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…</option>
        </select>
      </div>
      <div class="dialog-row">
        <label for="eventRepeatDays">Ù…Ø¯Ø© Ø§Ù„Ø­Ø¯Ø« (Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©ØŒ 0 = ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯)</label>
        <input type="number" id="eventRepeatDays" min="0" max="120" value="0" />
      </div>
      <div class="dialog-actions">
        <button onclick="saveEventFromDialog()">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="secondary" onclick="closeEventDialog()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ -->
  <div id="eventViewDialog" class="dialog-backdrop dialog-hidden">
    <div class="dialog-box">
      <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«</h3>
      <div id="viewDateLabel" class="event-view-date"></div>
      <div id="viewText" class="event-view-text"></div>
      <div class="dialog-actions">
        <button class="secondary" onclick="closeEventViewDialog()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <input type="file" id="backupFileInput" accept="application/json" style="display:none" />

  <script>
    /***********************
     * ØªØ¹Ø·ÙŠÙ„ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ø²Ø§Ø¦Ø± ÙÙ‚Ø·
     * (Ù„Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„)
     ***********************/
    document.addEventListener("keydown", function(e){
      if (window.isAdmin === true) return;

      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      const isTypingField = (tag === "input" || tag === "textarea" || e.target?.isContentEditable);

      // Ù„Ø§ Ù†Ø¹Ø·Ù„ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„Ù†Ø³Ø®/Ø§Ù„Ù„ØµÙ‚ Ø¯Ø§Ø®Ù„ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø©
      if (isTypingField) return;

      const k = (e.key || "").toLowerCase();
      const forbidden =
        e.key === "F12" ||
        (e.ctrlKey && ["s","p","u","o"].includes(k)) ||
        (e.ctrlKey && e.shiftKey && ["i","j","c"].includes(k));

      if (forbidden){
        e.preventDefault();
        e.stopPropagation();
      }
    }, {capture:true});

    const WEEKDAYS = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];

    // âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: (days + startWeekday) ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ¨Ù†Ù‰ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰.
    // Ø£Ù†Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹ ØªØ¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ø¬Ø¯ÙˆÙ„Ùƒ. Ø£Ø¨Ù‚ÙŠÙ†Ø§Ù‡Ø§ Ù…Ø«Ù„ Ù†Ø³Ø®ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
    const HIJRI_MONTHS = [
      { year: 1447, month: 7,  name: "Ø±Ø¬Ø¨",        days: 30, startWeekday: 0 },
      { year: 1447, month: 8,  name: "Ø´Ø¹Ø¨Ø§Ù†",      days: 30, startWeekday: 2 },
      { year: 1447, month: 9,  name: "Ø±Ù…Ø¶Ø§Ù†",      days: 29, startWeekday: 4 },
      { year: 1447, month: 10, name: "Ø´ÙˆØ§Ù„",       days: 30, startWeekday: 5 },
      { year: 1447, month: 11, name: "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©",  days: 29, startWeekday: 0 },
      { year: 1447, month: 12, name: "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©",   days: 29, startWeekday: 1 },
      { year: 1448, month: 1,  name: "Ù…Ø­Ø±Ù…",       days: 30, startWeekday: 2 },
      { year: 1448, month: 2,  name: "ØµÙØ±",        days: 29, startWeekday: 4 },
      { year: 1448, month: 3,  name: "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„", days: 29, startWeekday: 5 }
    ];

    const RANGE_START = { year: 1447, month: 7, day: 29 };
    const RANGE_END   = { year: 1448, month: 3, day: 29 };

    const ADMIN_DEFAULT_PASSWORD = "1234";
    const ADMIN_PASSWORD_KEY = "CAL_ADMIN_PWD_V1";
    const EVENTS_STORAGE_KEY = "CAL_EVENTS_V4";

    window.isAdmin = false;
    let events = {};
    let currentFilter = "";

    let hijriToGregMap = new Map();
    let countdownTimer = null;

    function compareHijri(a, b) {
      if (a.year !== b.year) return a.year - b.year;
      if (a.month !== b.month) return a.month - b.month;
      return a.day - b.day;
    }
    function inRange(d) {
      return compareHijri(d, RANGE_START) >= 0 && compareHijri(d, RANGE_END) <= 0;
    }
    function findMonthIndex(year, month) {
      return HIJRI_MONTHS.findIndex(m => m.year === year && m.month === month);
    }
    function getPrevMonthByYM(year, month) {
      const idx = findMonthIndex(year, month);
      if (idx <= 0) return null;
      const prev = HIJRI_MONTHS[idx - 1];
      return { year: prev.year, month: prev.month, days: prev.days };
    }
    function getNextMonthByYM(year, month) {
      const idx = findMonthIndex(year, month);
      if (idx === -1 || idx >= HIJRI_MONTHS.length - 1) return null;
      const next = HIJRI_MONTHS[idx + 1];
      return { year: next.year, month: next.month, days: next.days };
    }
    function addHijriDays(start, offset) {
      let y = start.year, m = start.month, d = start.day + offset;
      while (true) {
        const idx = findMonthIndex(y, m);
        if (idx === -1) return null;
        const monthInfo = HIJRI_MONTHS[idx];
        if (d <= monthInfo.days) break;
        d -= monthInfo.days;
        const next = getNextMonthByYM(y, m);
        if (!next) return null;
        y = next.year; m = next.month;
      }
      return { year: y, month: m, day: d };
    }
    function makeKey(year, month, day) { return `${year}-${month}-${day}`; }
    function parseKey(key){
      const [y,m,d] = key.split("-").map(Number);
      return {year:y, month:m, day:d};
    }

    function getTodayHijri() {
      const today = new Date();
      const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", {
        year: "numeric", month: "numeric", day: "numeric"
      });
      const parts = fmt.formatToParts(today);
      return {
        year: Number(parts.find(p => p.type === "year")?.value),
        month: Number(parts.find(p => p.type === "month")?.value),
        day: Number(parts.find(p => p.type === "day")?.value)
      };
    }

    // âœ… Ø¨Ù†Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ù‡Ø¬Ø±ÙŠâ†’Ù…ÙŠÙ„Ø§Ø¯ÙŠ: Ù…Ø­Ø§ÙˆÙ„Ø© Intl Ø«Ù… Fallback Ù…Ø±Ø³Ø§Ø© Ø«Ø§Ø¨ØªØ©
    function buildHijriToGregorianMap() {
      hijriToGregMap = new Map();

      // 1) Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (Intl umm al-qura)
      try {
        const start = new Date(); start.setDate(start.getDate() - 500); start.setHours(12,0,0,0);
        const end   = new Date(); end.setDate(end.getDate() + 900);  end.setHours(12,0,0,0);

        const fmt = new Intl.DateTimeFormat("ar-SA-u-ca-islamic-umalqura", {
          day:"numeric", month:"numeric", year:"numeric"
        });

        for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
          const parts = fmt.formatToParts(d);
          const day = Number(parts.find(p=>p.type==="day")?.value);
          const month = Number(parts.find(p=>p.type==="month")?.value);
          const year = Number(parts.find(p=>p.type==="year")?.value);
          if (!day || !month || !year) continue;

          const key = makeKey(year, month, day);
          if (!hijriToGregMap.has(key)){
            hijriToGregMap.set(key, new Date(d.getFullYear(), d.getMonth(), d.getDate()));
          }
        }
      } catch (_) {
        // ØªØ¬Ø§Ù‡Ù„ - Ø³Ù†Ø³ØªØ®Ø¯Ù… fallback
      }

      // Ù‡Ù„ ØªØºØ·ÙŠ Ø®Ø±ÙŠØ·Ø© Intl Ù†Ø·Ø§Ù‚Ù†Ø§ØŸ
      const needStart = makeKey(RANGE_START.year, RANGE_START.month, RANGE_START.day);
      const needEnd   = makeKey(RANGE_END.year, RANGE_END.month, RANGE_END.day);
      if (hijriToGregMap.has(needStart) && hijriToGregMap.has(needEnd)) return;

      // 2) Fallback Ù…Ù† Ù…Ø±Ø³Ø§Ø© Ø«Ø§Ø¨ØªØ© (Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚Ùƒ)
      // 29/7/1447 Ù‡Ù€ = 18/01/2026 Ù…
      const anchorHijri = { year: 1447, month: 7, day: 29 };
      const anchorGreg  = new Date(2026, 0, 18); // ÙŠÙ†Ø§ÙŠØ±=0

      let h = { ...anchorHijri };
      let g = new Date(anchorGreg.getFullYear(), anchorGreg.getMonth(), anchorGreg.getDate());

      while (compareHijri(h, RANGE_END) <= 0) {
        if (inRange(h)) {
          const key = makeKey(h.year, h.month, h.day);
          hijriToGregMap.set(key, new Date(g.getFullYear(), g.getMonth(), g.getDate()));
        }
        const nextH = addHijriDays(h, 1);
        if (!nextH) break;
        h = nextH;
        g.setDate(g.getDate() + 1);
      }
    }

    function hijriKeyToGregDate(key){ return hijriToGregMap.get(key) || null; }

    function getAdminPassword() {
      return localStorage.getItem(ADMIN_PASSWORD_KEY) || ADMIN_DEFAULT_PASSWORD;
    }

    function toggleAdmin() {
      if (window.isAdmin) {
        window.isAdmin = false;
        updateAdminStatus();
        renderAll();
        return;
      }
      const input = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© 1234):");
      if (input === null) return;
      if (input === getAdminPassword()) {
        window.isAdmin = true;
        updateAdminStatus();
        renderAll();
      } else {
        alert("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      }
    }

    function changeAdminPassword() {
      if (!window.isAdmin) return alert("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
      const current = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
      if (current === null) return;
      if (current !== getAdminPassword()) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      const newPwd = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„):");
      if (!newPwd || newPwd.length < 4) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹.");
      const confirmPwd = prompt("Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
      if (confirmPwd !== newPwd) return alert("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.");
      localStorage.setItem(ADMIN_PASSWORD_KEY, newPwd);
      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
    }

    function updateAdminStatus() {
      const badge = document.getElementById("adminStatus");
      const btn = document.getElementById("adminToggleBtn");
      const backupBtn = document.getElementById("backupBtn");
      const restoreBtn = document.getElementById("restoreBtn");

      if (window.isAdmin) {
        badge.classList.remove("status-visitor");
        badge.classList.add("status-admin");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± â€“ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø«";
        btn.textContent = "ğŸšª Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø¯ÙŠØ±";

        if (backupBtn) backupBtn.style.display = "inline-block";
        if (restoreBtn) restoreBtn.style.display = "inline-block";
      } else {
        badge.classList.remove("status-admin");
        badge.classList.add("status-visitor");
        badge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø± â€“ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙ‚Ø·";
        btn.textContent = "ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±";

        if (backupBtn) backupBtn.style.display = "none";
        if (restoreBtn) restoreBtn.style.display = "none";
      }
    }

    function loadEvents() {
      try {
        const raw = localStorage.getItem(EVENTS_STORAGE_KEY);
        events = raw ? JSON.parse(raw) : {};
      } catch {
        events = {};
      }
    }
    function saveEvents() {
      localStorage.setItem(EVENTS_STORAGE_KEY, JSON.stringify(events));
    }

    function renderCalendar() {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      let todayHijri = null;
      try { todayHijri = getTodayHijri(); } catch { todayHijri = null; }

      HIJRI_MONTHS.forEach((m) => {
        const monthCard = document.createElement("div");
        monthCard.className = "month-card";

        const header = document.createElement("div");
        header.className = "month-header";

        const nameSpan = document.createElement("div");
        nameSpan.className = "month-name";
        nameSpan.textContent = `${m.name} ${m.year} Ù‡Ù€`;

        const rangeSpan = document.createElement("div");
        rangeSpan.className = "month-range";

        let firstVisibleDay = 1;
        if (compareHijri({year:m.year,month:m.month,day:1}, RANGE_START) < 0) firstVisibleDay = RANGE_START.day;
        let lastVisibleDay = m.days;
        if (compareHijri({year:m.year,month:m.month,day:m.days}, RANGE_END) > 0) lastVisibleDay = RANGE_END.day;
        rangeSpan.textContent = `Ù…Ù† ${firstVisibleDay} Ø¥Ù„Ù‰ ${lastVisibleDay} ${m.name}`;

        header.appendChild(nameSpan);
        header.appendChild(rangeSpan);
        monthCard.appendChild(header);

        const body = document.createElement("div");
        body.className = "month-body";

        const table = document.createElement("table");
        table.className = "month-table";

        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        WEEKDAYS.forEach(d => {
          const th = document.createElement("th");
          th.textContent = d;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const prevMonth = getPrevMonthByYM(m.year, m.month);
        const nextMonth = getNextMonthByYM(m.year, m.month);

        let dayNum = 1;
        let nextMonthDay = 1;

        for (let week = 0; week < 6; week++) {
          const row = document.createElement("tr");

          for (let wd = 0; wd < 7; wd++) {
            const cell = document.createElement("td");
            let cellDay, cellMonth, cellYear, isPrevNext = false;

            const cellIndex = week * 7 + wd;

            if (cellIndex < m.startWeekday) {
              if (prevMonth) {
                const prevDays = prevMonth.days;
                const offset = m.startWeekday - cellIndex;
                cellDay = prevDays - offset + 1;
                cellMonth = prevMonth.month;
                cellYear = prevMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            } else if (dayNum <= m.days) {
              cellDay = dayNum++;
              cellMonth = m.month;
              cellYear = m.year;
            } else {
              if (nextMonth) {
                cellDay = nextMonthDay++;
                cellMonth = nextMonth.month;
                cellYear = nextMonth.year;
                isPrevNext = true;
              } else {
                cell.classList.add("out-of-range");
                row.appendChild(cell);
                continue;
              }
            }

            const dayObj = { year: cellYear, month: cellMonth, day: cellDay };
            const insideRange = inRange(dayObj);

            if (!insideRange) cell.classList.add("out-of-range");
            else if (isPrevNext) cell.classList.add("prev-next");

            if (insideRange && todayHijri &&
                dayObj.year === todayHijri.year &&
                dayObj.month === todayHijri.month &&
                dayObj.day === todayHijri.day) {
              cell.classList.add("today");
              cell.id = "todayCell";
            }

            const dn = document.createElement("div");
            dn.className = "day-number";
            dn.textContent = cellDay;
            cell.appendChild(dn);

            const evList = document.createElement("div");
            evList.className = "event-list";

            const key = makeKey(cellYear, cellMonth, cellDay);
            let dayEvents = events[key] || [];

            if (currentFilter) {
              const f = currentFilter.toLowerCase();
              dayEvents = dayEvents.filter(ev => (ev.text || "").toLowerCase().includes(f));
            }

            dayEvents.forEach(ev => {
              const pill = document.createElement("div");
              pill.className = "event-pill";
              pill.style.background = ev.color || "#2563eb";
              if (ev.pos) pill.classList.add("range-" + ev.pos);
              else pill.classList.add("range-single");

              const txt = document.createElement("span");
              txt.className = "event-text";
              txt.textContent = ev.text || "";
              txt.onclick = (e) => { e.stopPropagation(); viewEvent(parseKey(key), ev); };
              pill.appendChild(txt);

              const del = document.createElement("span");
              del.className = "event-delete";
              del.textContent = "Ã—";
              if (window.isAdmin) del.onclick = (e) => { e.stopPropagation(); deleteEvent(key, ev.id); };
              else del.classList.add("disabled");
              pill.appendChild(del);

              evList.appendChild(pill);
            });

            cell.appendChild(evList);
            if (insideRange) cell.onclick = () => handleDayClick(dayObj);
            row.appendChild(cell);
          }

          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        body.appendChild(table);
        monthCard.appendChild(body);
        container.appendChild(monthCard);
      });
    }

    function scrollToToday(){
      const el = document.getElementById("todayCell");
      if (!el) {
        alert("Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶.");
        return;
      }
      el.scrollIntoView({ behavior:"smooth", block:"center" });
    }

    let dialogDate = null;
    function handleDayClick(dayObj) {
      if (!window.isAdmin) return alert("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø®ØµØµØ© Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙ‚Ø·.");
      dialogDate = dayObj;
      openEventDialog(dayObj);
    }
    function openEventDialog(dayObj) {
      document.getElementById("dialogDateLabel").textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dayObj.day} / ${dayObj.month} / ${dayObj.year} Ù‡Ù€`;
      document.getElementById("eventTitleInput").value = "";
      document.getElementById("eventColorSelect").value = "#e53935";
      document.getElementById("eventRepeatDays").value = "0";
      document.getElementById("eventDialog").classList.remove("dialog-hidden");
    }
    function closeEventDialog() {
      document.getElementById("eventDialog").classList.add("dialog-hidden");
      dialogDate = null;
    }

    function saveEventFromDialog() {
      if (!dialogDate) return closeEventDialog();

      const title = document.getElementById("eventTitleInput").value.trim();
      const color = document.getElementById("eventColorSelect").value;
      let repeatDays = parseInt(document.getElementById("eventRepeatDays").value || "0", 10);
      if (isNaN(repeatDays) || repeatDays < 0) repeatDays = 0;
      if (!title) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø¯Ø«.");

      const groupId = "grp_" + Date.now().toString(36) + Math.random().toString(16).slice(2);
      const totalDays = repeatDays + 1;

      for (let i = 0; i < totalDays; i++) {
        const d = addHijriDays(dialogDate, i);
        if (!d || !inRange(d)) continue;
        const key = makeKey(d.year, d.month, d.day);
        if (!events[key]) events[key] = [];

        let pos = "single";
        if (totalDays === 1) pos = "single";
        else if (i === 0) pos = "start";
        else if (i === totalDays - 1) pos = "end";
        else pos = "mid";

        events[key].push({ id: groupId + "_" + i, groupId, text: title, color, pos });
      }

      saveEvents();
      renderAll();
      closeEventDialog();
    }

    function deleteEvent(key, id) {
      if (!window.isAdmin) return alert("Ø­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
      if (!events[key]) return;

      const target = events[key].find(ev => ev.id === id);
      const groupId = target && target.groupId;

      if (groupId) {
        for (const k in events) {
          if (!Object.prototype.hasOwnProperty.call(events, k)) continue;
          events[k] = events[k].filter(ev => ev.groupId !== groupId);
          if (events[k].length === 0) delete events[k];
        }
      } else {
        events[key] = events[key].filter(ev => ev.id !== id);
        if (events[key].length === 0) delete events[key];
      }

      saveEvents();
      renderAll();
    }

    function deleteEventGroup(groupId){
      if (!window.isAdmin) return alert("Ø­Ø°Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.");
      if (!groupId) return;

      if (!confirm("ØªØ£ÙƒÙŠØ¯: Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…ØŸ")) return;

      for (const k in events) {
        if (!Object.prototype.hasOwnProperty.call(events, k)) continue;
        events[k] = (events[k] || []).filter(ev => ev.groupId !== groupId && ev.id !== groupId);
        if (events[k].length === 0) delete events[k];
      }
      saveEvents();
      renderAll();
    }

    function viewEvent(dayObj, ev) {
      document.getElementById("viewDateLabel").textContent = `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dayObj.day} / ${dayObj.month} / ${dayObj.year} Ù‡Ù€`;
      document.getElementById("viewText").textContent = ev.text || "";
      document.getElementById("eventViewDialog").classList.remove("dialog-hidden");
    }
    function closeEventViewDialog() {
      document.getElementById("eventViewDialog").classList.add("dialog-hidden");
    }

    function applyFilter() {
      currentFilter = document.getElementById("filterInput").value.trim();
      renderAll();
    }
    function clearFilter() {
      document.getElementById("filterInput").value = "";
      currentFilter = "";
      renderAll();
    }

    function printCalendar(){ window.print(); }
    function exportPDF() {
      const element = document.querySelector(".page");
      const opt = {
        margin: 0.5,
        filename: "calendar-1447-1448-ummalqura.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "cm", format: "a4", orientation: "landscape" }
      };
      html2pdf().from(element).set(opt).save();
    }

    // âœ… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Ù„Ù„Ù€ Admin ÙÙ‚Ø·)
    function downloadBackup() {
      if (!window.isAdmin) return;
      const dataStr = JSON.stringify(events, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "calendar-events-backup.json";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function triggerRestore(){
      if (!window.isAdmin) return;
      document.getElementById("backupFileInput").click();
    }

    document.getElementById("backupFileInput").addEventListener("change", function (e) {
      if (!window.isAdmin) return;
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = JSON.parse(evt.target.result);
          if (typeof data !== "object" || Array.isArray(data)) throw new Error("bad");
          events = data;
          saveEvents();
          renderAll();
          alert("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.");
        } catch {
          alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù.");
        } finally {
          e.target.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    });

    function normalizeEvents(){
      const byGroup = new Map();

      for (const key in events){
        if (!Object.prototype.hasOwnProperty.call(events, key)) continue;
        const list = events[key] || [];
        for (const ev of list){
          const gid = ev.groupId || ev.id;
          if (!byGroup.has(gid)){
            byGroup.set(gid, { groupId: ev.groupId || null, title: ev.text || "", color: ev.color || "#2563eb", keys: new Set() });
          }
          byGroup.get(gid).keys.add(key);
        }
      }

      const arr = [];
      for (const [gid, item] of byGroup.entries()){
        const keys = Array.from(item.keys);
        keys.sort((a,b)=> compareHijri(parseKey(a), parseKey(b)));
        const startKey = keys[0];
        const endKey = keys[keys.length-1];
        arr.push({
          id: gid,
          groupId: item.groupId,
          title: item.title,
          color: item.color,
          startHijri: parseKey(startKey),
          endHijri: parseKey(endKey),
          startKey, endKey
        });
      }
      arr.sort((a,b)=> compareHijri(a.startHijri, b.startHijri));
      return arr;
    }

    function startOfDay(date){ return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0,0,0,0); }
    function endOfDay(date){ return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23,59,59,999); }

    function formatDuration(ms){
      if (ms < 0) ms = 0;
      const s = Math.floor(ms/1000);
      const days = Math.floor(s / 86400);
      const h = Math.floor((s % 86400)/3600);
      const m = Math.floor((s % 3600)/60);
      const sec = s % 60;
      const dd = days ? `${days} ÙŠÙˆÙ… ` : "";
      return `${dd}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
    function hijriLabel(d){ return `${d.day}/${d.month}/${d.year}Ù‡Ù€`; }

    function getEventStatus(ev){
      const gStart = hijriKeyToGregDate(ev.startKey);
      const gEnd = hijriKeyToGregDate(ev.endKey);
      if (!gStart || !gEnd) return "unknown";
      const now = new Date();
      const start = startOfDay(gStart);
      const end = endOfDay(gEnd);
      if (now < start) return "upcoming";
      if (now >= start && now <= end) return "ongoing";
      return "ended";
    }

    function sortEvents(list){
      const mode = document.getElementById("sortSelect").value;
      if (mode === "date") return list;

      const bucket = { ongoing: 0, upcoming: 1, ended: 2, unknown: 3 };
      if (mode === "upcoming") { bucket.upcoming=0; bucket.ongoing=1; bucket.ended=2; }
      if (mode === "ongoing")  { bucket.ongoing=0; bucket.upcoming=1; bucket.ended=2; }
      if (mode === "ended")    { bucket.ended=0; bucket.ongoing=1; bucket.upcoming=2; }

      return [...list].sort((a,b)=>{
        const sa = getEventStatus(a);
        const sb = getEventStatus(b);
        const ba = bucket[sa] ?? 9;
        const bb = bucket[sb] ?? 9;
        if (ba !== bb) return ba - bb;
        return compareHijri(a.startHijri, b.startHijri);
      });
    }

    function renderSidebar(){
      const box = document.getElementById("eventsSidebar");
      const count = document.getElementById("sidebarCount");
      box.innerHTML = "";

      let list = normalizeEvents();
      if (currentFilter){
        const f = currentFilter.toLowerCase();
        list = list.filter(x => (x.title||"").toLowerCase().includes(f));
      }
      list = sortEvents(list);

      count.textContent = `${list.length} Ø­Ø¯Ø«`;

      if (list.length === 0){
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
        stopCountdownLoop();
        return;
      }

      for (const ev of list){
        const item = document.createElement("div");
        item.className = "event-item";

        const top = document.createElement("div");
        top.className = "event-item-top";

        const left = document.createElement("div");
        left.className = "event-left";

        const dot = document.createElement("div");
        dot.className = "event-dot";
        dot.style.background = ev.color;

        const text = document.createElement("div");
        const title = document.createElement("div");
        title.className = "event-item-title";
        title.textContent = ev.title || "(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)";

        const dates = document.createElement("div");
        dates.className = "event-item-dates";
        const sameDay = compareHijri(ev.startHijri, ev.endHijri) === 0;
        dates.textContent = sameDay ? `ğŸ“… ${hijriLabel(ev.startHijri)}` : `ğŸ“… ${hijriLabel(ev.startHijri)} â†’ ${hijriLabel(ev.endHijri)}`;

        text.appendChild(title);
        text.appendChild(dates);

        left.appendChild(dot);
        left.appendChild(text);

        top.appendChild(left);
        item.appendChild(top);

        const timer = document.createElement("div");
        timer.className = "event-item-timer";
        timer.id = `timer_${ev.id}`;
        timer.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨...";
        item.appendChild(timer);

        const actions = document.createElement("div");
        actions.className = "event-actions";
        if (window.isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.className = "danger small";
          delBtn.textContent = "ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ø­Ø¯Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„";
          delBtn.onclick = (e) => { e.stopPropagation(); deleteEventGroup(ev.groupId || ev.id); };
          actions.appendChild(delBtn);
        }
        if (actions.children.length) item.appendChild(actions);

        item.onclick = () => {
          document.getElementById("viewDateLabel").textContent = `Ù…Ù† ${hijriLabel(ev.startHijri)} Ø¥Ù„Ù‰ ${hijriLabel(ev.endHijri)}`;
          document.getElementById("viewText").textContent = ev.title || "";
          document.getElementById("eventViewDialog").classList.remove("dialog-hidden");
        };

        box.appendChild(item);
      }

      startCountdownLoop(list);
    }

    function stopCountdownLoop(){
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
    }

    function startCountdownLoop(eventList){
      stopCountdownLoop();

      function tick(){
        const now = new Date();

        for (const ev of eventList){
          const timerEl = document.getElementById(`timer_${ev.id}`);
          if (!timerEl) continue;

          const gStart = hijriKeyToGregDate(ev.startKey);
          const gEnd = hijriKeyToGregDate(ev.endKey);

          if (!gStart || !gEnd){
            timerEl.className = "event-item-timer timer-ended";
            timerEl.textContent = "â›” ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø« (ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ)";
            continue;
          }

          const start = startOfDay(gStart);
          const end = endOfDay(gEnd);

          if (now < start){
            timerEl.className = "event-item-timer timer-upcoming";
            timerEl.textContent = `â³ Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¯Ø«: ${formatDuration(start - now)}`;
          } else if (now >= start && now <= end){
            timerEl.className = "event-item-timer timer-ongoing";
            timerEl.textContent = `âœ… Ø§Ù„Ø­Ø¯Ø« Ø¬Ø§Ø±Ù â€” Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©: ${formatDuration(end - now)}`;
          } else {
            timerEl.className = "event-item-timer timer-ended";
            timerEl.textContent = `âœ”ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø­Ø¯Ø«`;
          }
        }
      }

      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function scheduleMidnightRefresh() {
      const now = new Date();
      const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 1);
      setTimeout(() => {
        renderAll();
        scheduleMidnightRefresh();
      }, nextMidnight - now);
    }

    function renderAll(){
      buildHijriToGregorianMap();
      renderCalendar();
      renderSidebar();
      updateAdminStatus(); // Ù„Ø¶Ø¨Ø· Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø®/Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    }

    loadEvents();
    updateAdminStatus();
    renderAll();
    scheduleMidnightRefresh();
  </script>
</body>
</html>
